<!doctype html>
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>{{ scenario_title }}</title>
	<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§©</text></svg>">
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
		.container { max-width: 800px; margin: 0 auto; }
		.box { border: 1px solid #ddd; padding: 16px; border-radius: 8px; }
		.row { display: flex; gap: 8px; }
		input[type="text"] { flex: 1; padding: 10px; }
		button { padding: 10px 14px; cursor: pointer; }
		.badge { background: #efefef; border-radius: 12px; padding: 4px 10px; }
		.log { max-height: 300px; overflow: auto; border: 1px solid #eee; padding: 8px; }
		.log .item { padding: 6px 4px; border-bottom: 1px solid #f0f0f0; }
	</style>
</head>
<body>
	<div class="container">
		<div style="display:flex; align-items:center; gap:12px;">
			<h1 style="margin:0;">{{ scenario.title }}</h1>
		</div>
		<p style="color:#666; margin-top:-8px;">í˜„ì¬ í¬íŠ¸: <span id="port"></span></p>
		<div class="box" style="white-space: pre-wrap; line-height: 1.5; font-size: 16px; background: #f8f9fa; border: 2px solid #e9ecef;">
			<strong>ì•Œëª¸ì˜ ë‚¨ìê°€ ì‚¬ë§‰ í•œ ê°€ìš´ë°ì—ì„œ ì£½ì–´ìˆì—ˆë‹¤. ê·¸ì˜ ì†ì—ëŠ” ë¶€ëŸ¬ì§„ ì„±ëƒ¥ì´ ë“¤ë ¤ìˆì—ˆë‹¤. ì™œ ê·¸ëŠ” ì‚¬ë§‰ í•œ ê°€ìš´ë°ì—ì„œ ì£½ì–´ìˆì—ˆì„ê¹Œ?</strong>
		</div>
		<p>ë‚¨ì€ í† í°: <span id="tokens" class="badge">20</span> Â· ë‚¨ì€ íŒíŠ¸: <span id="hints" class="badge">3</span></p>
		<div class="box" style="margin-top: 12px;">
			<div class="row">
				<input id="question" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ/ì•„ë‹ˆì˜¤/ë¬´ê´€ìœ¼ë¡œ ë‹µë³€)" />
				<button id="askBtn">ì§ˆë¬¸</button>
				<button id="hintBtn" title="íŒíŠ¸ ìš”ì²­">íŒíŠ¸</button>
			</div>
			<div class="row" style="margin-top: 8px;">
				<input id="guess" type="text" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" />
				<button id="guessBtn">ì •ë‹µ ì œì¶œ</button>
				<button id="revealBtn" title="ì •ë‹µ ê³µê°œ">ì •ë‹µ ê³µê°œ</button>
				<button id="resetBtn" title="ê²Œì„ ì¬ì‹œì‘">ì¬ì‹œì‘</button>
			</div>
		</div>
		<div style="margin-top: 16px;">
			<h3>ëŒ€í™” ë¡œê·¸</h3>
			<div id="log" class="log"></div>
			<div id="result" style="margin-top: 8px;"></div>
			
			<!-- ì§ˆë¬¸ ë¶„ë¥˜ í”¼ë“œë°± ì„¹ì…˜ -->
			<div id="feedbackSection" style="margin-top: 16px; display: none;">
				<h4>ì´ ì§ˆë¬¸ì˜ ì˜¬ë°”ë¥¸ ë¶„ë¥˜ëŠ”?</h4>
				<p style="color: #666; font-size: 14px; margin-bottom: 12px;">ì±—ë´‡ ë‹µë³€ì— ê´€ê³„ì—†ì´, ì´ ì§ˆë¬¸ì´ ì–´ë–¤ ë¶„ë¥˜ì— ì†í•´ì•¼ í•˜ëŠ”ì§€ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
				<div style="display: flex; gap: 8px; margin-bottom: 8px;">
					<button id="feedbackYes" class="feedback-btn" data-type="yes">âœ… ì˜ˆ (ì´ ì§ˆë¬¸ì€ 'ì˜ˆ'ë¡œ ë‹µí•´ì•¼ í•¨)</button>
					<button id="feedbackNo" class="feedback-btn" data-type="no">âŒ ì•„ë‹ˆì˜¤ (ì´ ì§ˆë¬¸ì€ 'ì•„ë‹ˆì˜¤'ë¡œ ë‹µí•´ì•¼ í•¨)</button>
					<button id="feedbackAmbiguous" class="feedback-btn" data-type="ambiguous">â“ ì• ë§¤í•¨ (ì´ ì§ˆë¬¸ì€ 'ì• ë§¤í•¨'ìœ¼ë¡œ ë‹µí•´ì•¼ í•¨)</button>
				</div>
				<div id="feedbackComment" style="display: none;">
					<textarea id="commentText" placeholder="ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ì´ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" style="width: 100%; height: 60px; margin-top: 8px;"></textarea>
					<button id="submitFeedback" style="margin-top: 8px;">ë¶„ë¥˜ í”¼ë“œë°± ì œì¶œ</button>
				</div>
			</div>
			
			<!-- ì •ë‹µ í”¼ë“œë°± ì„¹ì…˜ -->
			<div id="answerFeedbackSection" style="margin-top: 16px; display: none;">
				<h4>ì´ ì •ë‹µì´ ì˜¬ë°”ë¥¸ê°€ìš”?</h4>
				<p style="color: #666; font-size: 14px; margin-bottom: 12px;">ì‹œìŠ¤í…œì´ ì •ë‹µìœ¼ë¡œ íŒë‹¨í•œ ë‹µë³€ì´ ì‹¤ì œë¡œ ì˜¬ë°”ë¥¸ì§€ í”¼ë“œë°±í•´ì£¼ì„¸ìš”.</p>
				<div style="display: flex; gap: 8px; margin-bottom: 8px;">
					<button id="answerFeedbackCorrect" class="answer-feedback-btn" data-type="correct">âœ… ë§ìŠµë‹ˆë‹¤ (ì´ ë‹µë³€ì´ ì •ë‹µì…ë‹ˆë‹¤)</button>
					<button id="answerFeedbackIncorrect" class="answer-feedback-btn" data-type="incorrect">âŒ í‹€ë ¸ìŠµë‹ˆë‹¤ (ì´ ë‹µë³€ì´ ì˜¤ë‹µì…ë‹ˆë‹¤)</button>
				</div>
				<div id="answerFeedbackComment" style="display: none;">
					<textarea id="answerCommentText" placeholder="ì™œ ë§ê±°ë‚˜ í‹€ë ¸ëŠ”ì§€ ì´ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" style="width: 100%; height: 60px; margin-top: 8px;"></textarea>
					<button id="submitAnswerFeedback" style="margin-top: 8px;">ì •ë‹µ í”¼ë“œë°± ì œì¶œ</button>
				</div>
			</div>
		</div>
		
		<!-- ë°í˜€ì§„ ì‚¬ì‹¤ ë¡œê·¸ -->
		<div id="factsSection" style="margin-top: 16px; display: none;">
			<h3>ë°í˜€ì§„ ì‚¬ì‹¤</h3>
			<div id="facts" class="log" style="background: #f8f9fa; border: 1px solid #e9ecef;"></div>
		</div>

		<!-- ê°„ë‹¨ ëª¨ë‹¬ -->
		<div id="hintModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
			<div style="background:#fff; padding:16px; border-radius:8px; max-width:420px; width:90%;">
				<h3>íŒíŠ¸</h3>
				<p id="hintText" style="white-space:pre-wrap"></p>
				<div style="text-align:right; margin-top:8px;">
					<button id="hintClose">ë‹«ê¸°</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		const logEl = document.getElementById('log');
		const tokensEl = document.getElementById('tokens');
		const resultEl = document.getElementById('result');
		document.getElementById('port').textContent = window.location.port || '80';
		// í˜„ì¬ ì§ˆë¬¸/ë‹µë³€ì„ ì „ì—­ì— ë³´ê´€í•˜ì—¬ í”¼ë“œë°±ì— í¬í•¨
		let currentQuestion = '';
		let currentAnswer = '';
		
		// ì´ˆê¸° ìƒíƒœ ë¡œë“œ
		refreshState();

		async function refreshState() {
			const res = await fetch('/state');
			const data = await res.json();
			document.getElementById('hints').textContent = data.hints_left ?? 0;
			document.getElementById('tokens').textContent = data.tokens_left ?? 20;
		}

		function appendLog(q, a) {
			const div = document.createElement('div');
			div.className = 'item';
			let text;
			if (typeof a === 'object') {
				text = `Q: ${q}  â†’  A: ${a.result}`;
				if (a.evidence) text += ` (${a.evidence})`;
			} else {
				text = `Q: ${q}  â†’  A: ${a}`;
			}
			div.textContent = text;
			logEl.prepend(div);
		}

		document.getElementById('askBtn').addEventListener('click', async () => {
			const question = document.getElementById('question').value.trim();
			if (!question) return;
			const res = await fetch('/ask', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question }) });
			const data = await res.json();
			if (data.error) { resultEl.textContent = data.error; return; }
			tokensEl.textContent = data.tokensLeft;
			if (data.result === 'non_binary') {
				resultEl.textContent = data.message || 'ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µí•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
				if (Array.isArray(data.suggestions) && data.suggestions.length) {
					const s = document.createElement('div');
					s.style.marginTop = '6px';
					s.textContent = 'ì˜ˆì‹œ: ' + data.suggestions.join(' / ');
					resultEl.appendChild(s);
				}
			} else {
				// ëª¨ë“  ë‹µë³€ì„ ë¡œê·¸ì— í‘œì‹œ
				let answerText = data.answerText || (data.result === 'yes' ? 'ì˜ˆ' : data.result === 'no' ? 'ì•„ë‹ˆì˜¤' : data.result === 'irrelevant' ? 'ë¬´ê´€' : data.result);
				
				// ë‹µë³€ì„ currentAnswerì— ì €ì¥
				currentAnswer = answerText;
				// ì§ˆë¬¸ë„ ì €ì¥í•˜ì—¬ í”¼ë“œë°±ì— í¬í•¨
				currentQuestion = question;
				
				// non_binaryì¸ ê²½ìš° ë©”ì‹œì§€ë„ í•¨ê»˜ í‘œì‹œ
				if (data.result === 'non_binary' && data.message) {
					answerText += ` (${data.message})`;
				}
				
				appendLog(question, answerText);
				
				// ë‹µë³€ í›„ í”¼ë“œë°± ì„¹ì…˜ í‘œì‹œ
				setTimeout(() => {
					const feedbackSection = document.getElementById('feedbackSection');
					feedbackSection.style.display = 'block';
				}, 500);
				
				// ë°í˜€ì§„ ì‚¬ì‹¤ ì—…ë°ì´íŠ¸
				if (data.discovered_facts && data.discovered_facts.length > 0) {
					updateDiscoveredFacts(data.discovered_facts);
				}
			}
			document.getElementById('question').value = '';
		});

		document.getElementById('guessBtn').addEventListener('click', async () => {
			const guess = document.getElementById('guess').value.trim();
			if (!guess) return;
			const res = await fetch('/guess', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ guess }) });
			const data = await res.json();
			if (data.error) { resultEl.textContent = data.error; return; }
			
			// ì •ë‹µ í”¼ë“œë°±ì„ ìœ„í•œ ë°ì´í„° ì €ì¥
			currentAnswer = guess;
			document.getElementById('answerFeedbackSection').style.display = 'block';
			
			if (data.correct) {
				resultEl.textContent = `ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰\n\nì ìˆ˜: ${data.score}ì `;
			} else {
				resultEl.textContent = `ì˜¤ë‹µì…ë‹ˆë‹¤.\nì ìˆ˜: ${data.score}ì `;
			}
		});
		document.getElementById('revealBtn').addEventListener('click', async () => {
			const res = await fetch('/reveal');
			const data = await res.json();
			alert(`${data.explanation}\n\nì •ë‹µ: ${data.answer}`);
		});

			document.getElementById('resetBtn').addEventListener('click', async () => {
			try {
				const response = await fetch('/reset', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					}
				});
				
				const data = await response.json();
				
				if (response.ok) {
					// ìƒíƒœ ì—…ë°ì´íŠ¸
					document.getElementById('tokens').textContent = data.tokens_left;
					document.getElementById('hints').textContent = data.hints_left;
					
					// íŒíŠ¸ ë²„íŠ¼ í™œì„±í™”
					document.getElementById('hintBtn').disabled = false;
					document.getElementById('hintBtn').textContent = 'íŒíŠ¸';
					
					// ëŒ€í™” ë¡œê·¸ ì´ˆê¸°í™”
					document.getElementById('log').innerHTML = '';
					
					alert(data.message);
				} else {
					alert('ê²Œì„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				}
			} catch (error) {
				console.error('ë¦¬ì…‹ ìš”ì²­ ì‹¤íŒ¨:', error);
				alert('ê²Œì„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
			}
		});

		document.getElementById('hintBtn').addEventListener('click', async () => {
			try {
				const response = await fetch('/hint', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					}
				});
				
				const data = await response.json();
				
				if (response.ok) {
					document.getElementById('hintText').textContent = data.hint;
					document.getElementById('hintModal').style.display = 'flex';
					// íŒíŠ¸ ìˆ˜ë§Œ ì—…ë°ì´íŠ¸ (í† í°ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
					document.getElementById('hints').textContent = data.hints_left;
					
					// íŒíŠ¸ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
					if (data.hints_left <= 0) {
						document.getElementById('hintBtn').disabled = true;
						document.getElementById('hintBtn').textContent = 'íŒíŠ¸ ì—†ìŒ';
					}
				} else {
					alert(data.error || 'íŒíŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
				}
			} catch (error) {
				console.error('íŒíŠ¸ ìš”ì²­ ì‹¤íŒ¨:', error);
				alert('íŒíŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
			}
		});

		document.getElementById('hintClose').addEventListener('click', () => {
			document.getElementById('hintModal').style.display = 'none';
		});
		
		// ë°í˜€ì§„ ì‚¬ì‹¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
		function updateDiscoveredFacts(facts) {
			const factsSection = document.getElementById('factsSection');
			const factsDiv = document.getElementById('facts');
			
			if (facts && facts.length > 0) {
				factsSection.style.display = 'block';
				factsDiv.innerHTML = facts.map(fact => 
					`<div class="item" style="color: #28a745; font-weight: 500;">âœ“ ${fact}</div>`
				).join('');
			}
		}

		// ì§ˆë¬¸ ë¶„ë¥˜ í”¼ë“œë°± ê¸°ëŠ¥
		// í”¼ë“œë°± ë²„íŠ¼ í´ë¦­
		document.querySelectorAll('.feedback-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				const correctClassification = btn.dataset.type; // yes, no, ambiguous
				const feedbackComment = document.getElementById('feedbackComment');
				const commentText = document.getElementById('commentText');
				
				// ëª¨ë“  ë¶„ë¥˜ì— ëŒ€í•´ ëŒ“ê¸€ ì…ë ¥ ê°€ëŠ¥
				feedbackComment.style.display = 'block';
				commentText.focus();
				
				// ì„ íƒëœ ë²„íŠ¼ í‘œì‹œ
				document.querySelectorAll('.feedback-btn').forEach(b => b.style.backgroundColor = '');
				btn.style.backgroundColor = '#e3f2fd';
			});
		});

		// í”¼ë“œë°± ì œì¶œ
		document.getElementById('submitFeedback').addEventListener('click', () => {
			const selectedBtn = document.querySelector('.feedback-btn[style*="background-color: rgb(227, 242, 253)"]');
			if (!selectedBtn) {
				alert('ë¨¼ì € ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}
			
			const correctClassification = selectedBtn.dataset.type;
			const comment = document.getElementById('commentText').value.trim();
			submitClassificationFeedback(correctClassification, comment);
		});

		// ì§ˆë¬¸ ë¶„ë¥˜ í”¼ë“œë°± ì œì¶œ í•¨ìˆ˜
		async function submitClassificationFeedback(correctClassification, comment) {
			try {
				const response = await fetch('/feedback', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						question: currentQuestion,
						chatbot_answer: currentAnswer,
						correct_classification: correctClassification,
						comment: comment
					})
				});
				
				const data = await response.json();
				
				if (data.status === 'success') {
					alert(`ì§ˆë¬¸ì´ '${getClassificationText(correctClassification)}' ë¶„ë¥˜ë¡œ í•™ìŠµë˜ì—ˆìŠµë‹ˆë‹¤!`);
					// í”¼ë“œë°± ì„¹ì…˜ ìˆ¨ê¸°ê¸°
					document.getElementById('feedbackSection').style.display = 'none';
					document.getElementById('feedbackComment').style.display = 'none';
					document.getElementById('commentText').value = '';
					// ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
					document.querySelectorAll('.feedback-btn').forEach(b => b.style.backgroundColor = '');
				} else {
					alert('í”¼ë“œë°± ì €ì¥ ì‹¤íŒ¨: ' + data.message);
				}
			} catch (error) {
				alert('í”¼ë“œë°± ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
			}
		}

		// ë¶„ë¥˜ í…ìŠ¤íŠ¸ ë³€í™˜ í•¨ìˆ˜
		function getClassificationText(classification) {
			const map = {
				'yes': 'ì˜ˆ',
				'no': 'ì•„ë‹ˆì˜¤',
				'ambiguous': 'ì• ë§¤í•¨'
			};
			return map[classification] || classification;
		}

		// ì •ë‹µ í”¼ë“œë°± ê¸°ëŠ¥
		// ì •ë‹µ í”¼ë“œë°± ë²„íŠ¼ í´ë¦­
		document.querySelectorAll('.answer-feedback-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				const userFeedback = btn.dataset.type; // correct, incorrect
				const answerFeedbackComment = document.getElementById('answerFeedbackComment');
				const answerCommentText = document.getElementById('answerCommentText');
				
				// ëŒ“ê¸€ ì…ë ¥ í‘œì‹œ
				answerFeedbackComment.style.display = 'block';
				answerCommentText.focus();
				
				// ì„ íƒëœ ë²„íŠ¼ í‘œì‹œ
				document.querySelectorAll('.answer-feedback-btn').forEach(b => b.style.backgroundColor = '');
				btn.style.backgroundColor = '#e3f2fd';
			});
		});

		// ì •ë‹µ í”¼ë“œë°± ì œì¶œ
		document.getElementById('submitAnswerFeedback').addEventListener('click', () => {
			const selectedBtn = document.querySelector('.answer-feedback-btn[style*="background-color: rgb(227, 242, 253)"]');
			if (!selectedBtn) {
				alert('ë¨¼ì € í”¼ë“œë°±ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}
			
			const userFeedback = selectedBtn.dataset.type;
			const comment = document.getElementById('answerCommentText').value.trim();
			submitAnswerFeedback(userFeedback, comment);
		});

		// ì •ë‹µ í”¼ë“œë°± ì œì¶œ í•¨ìˆ˜
		function submitAnswerFeedback(userFeedback, comment) {
			if (!currentAnswer) {
				alert('ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
				return;
			}
			
			fetch('/answer_feedback', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					answer_text: currentAnswer,
					user_feedback: userFeedback,
					comment: comment
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.status === 'success') {
					alert('ì •ë‹µ í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
					// í”¼ë“œë°± ì„¹ì…˜ ìˆ¨ê¸°ê¸°
					document.getElementById('answerFeedbackSection').style.display = 'none';
					// ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
					document.getElementById('answerCommentText').value = '';
					document.querySelectorAll('.answer-feedback-btn').forEach(b => b.style.backgroundColor = '');
				} else {
					alert('í”¼ë“œë°± ì €ì¥ ì‹¤íŒ¨: ' + data.message);
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('í”¼ë“œë°± ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
			});
		}
	</script>
</body>
</html>


